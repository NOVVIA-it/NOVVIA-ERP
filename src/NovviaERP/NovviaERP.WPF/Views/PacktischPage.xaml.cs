using System.Linq;using System.Windows;using System.Windows.Controls;using System.Windows.Input;using NovviaERP.Core.Entities;
namespace NovviaERP.WPF.Views{public partial class PacktischPage:Page{private Bestellung? _aktuelle;
public PacktischPage(){InitializeComponent();Loaded+=async(s,e)=>dgOffene.ItemsSource=await App.Db.GetBestellungenAsync(BestellStatus.Bezahlt);txtScan.Focus();}
private async void Scan_KeyDown(object s,KeyEventArgs e){if(e.Key!=Key.Enter||_aktuelle==null)return;var code=txtScan.Text.Trim();txtScan.Text="";
var pos=_aktuelle.Positionen.FirstOrDefault(p=>p.ArtNr==code);if(pos!=null&&pos.Geliefert<pos.Menge){pos.Geliefert++;dgPositionen.Items.Refresh();txtStatus.Text=$"✓ {pos.Name} gescannt ({pos.Geliefert}/{pos.Menge})";if(_aktuelle.Positionen.All(p=>p.Geliefert>=p.Menge))txtStatus.Text="✓ KOMPLETT - Bereit zum Versenden!";}else txtStatus.Text="⚠ Artikel nicht in Bestellung!";}
private async void Bestellung_Click(object s,MouseButtonEventArgs e){if(dgOffene.SelectedItem is Bestellung b){_aktuelle=await App.Db.GetBestellungByIdAsync(b.Id);txtBestellung.Text=$"{_aktuelle?.BestellNr} - {_aktuelle?.Kunde?.Nachname}";dgPositionen.ItemsSource=_aktuelle?.Positionen;txtScan.Focus();}}
private async void Abschliessen_Click(object s,RoutedEventArgs e){if(_aktuelle==null)return;await App.Db.CreateLieferscheinAsync(_aktuelle.Id);await App.Db.UpdateBestellStatusAsync(_aktuelle.Id,BestellStatus.Versendet);MessageBox.Show("Bestellung abgeschlossen!");dgOffene.ItemsSource=await App.Db.GetBestellungenAsync(BestellStatus.Bezahlt);_aktuelle=null;dgPositionen.ItemsSource=null;txtBestellung.Text="";}}}
