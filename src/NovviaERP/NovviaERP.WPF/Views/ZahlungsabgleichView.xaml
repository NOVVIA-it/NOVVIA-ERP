<UserControl x:Class="NovviaERP.WPF.Views.ZahlungsabgleichView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:NovviaERP.WPF.Views"
             Background="#f5f5f5">
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border Background="White" BorderBrush="#ddd" BorderThickness="0,0,0,1" Padding="20,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="Zahlungsabgleich" FontSize="24" FontWeight="SemiBold" Foreground="#333"/>
                    <TextBlock x:Name="txtAnzahl" Text="" FontSize="14" Foreground="#888" VerticalAlignment="Center" Margin="15,0,0,0"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button Content="MT940 Import" Click="ImportMT940_Click"
                            Background="#6c757d" Foreground="White" Padding="12,8" BorderThickness="0" Margin="0,0,8,0"/>
                    <Button Content="CAMT Import" Click="ImportCAMT_Click"
                            Background="#6c757d" Foreground="White" Padding="12,8" BorderThickness="0" Margin="0,0,8,0"/>
                    <Button Content="Auto-Matching" Click="AutoMatch_Click"
                            Background="#28a745" Foreground="White" Padding="12,8" BorderThickness="0" Margin="0,0,8,0"/>
                    <Button Content="Aktualisieren" Click="Aktualisieren_Click"
                            Background="#0078D4" Foreground="White" Padding="12,8" BorderThickness="0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Tabs -->
        <TabControl x:Name="tabZahlungen" Grid.Row="1" Margin="20,15,20,0" BorderThickness="1" BorderBrush="#ddd"
                    SelectionChanged="Tab_Changed">

            <!-- Tab: Offene Zahlungen -->
            <TabItem Header="Offene Zahlungen" Padding="15,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Filter -->
                    <Border Background="#f8f8f8" Padding="10" Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Von:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                            <DatePicker x:Name="dpVon" Width="120" SelectedDateChanged="Filter_Changed"/>
                            <TextBlock Text="Bis:" VerticalAlignment="Center" Margin="15,0,5,0"/>
                            <DatePicker x:Name="dpBis" Width="120" SelectedDateChanged="Filter_Changed"/>
                            <CheckBox x:Name="chkNurUnmatched" Content="Nur nicht zugeordnete"
                                      IsChecked="True" VerticalAlignment="Center" Margin="20,0,0,0"
                                      Checked="Filter_Changed" Unchecked="Filter_Changed"/>
                        </StackPanel>
                    </Border>

                    <!-- DataGrid -->
                    <DataGrid x:Name="dgZahlungen" Grid.Row="1" AutoGenerateColumns="False" IsReadOnly="True"
                              SelectionMode="Single" SelectionUnit="FullRow"
                              GridLinesVisibility="Horizontal" HeadersVisibility="Column"
                              RowBackground="White" AlternatingRowBackground="#fafafa"
                              SelectionChanged="DG_SelectionChanged">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Datum" Binding="{Binding Buchungsdatum, StringFormat=dd.MM.yyyy}" Width="90"/>
                            <DataGridTextColumn Header="Betrag" Binding="{Binding Betrag, StringFormat=N2}" Width="100">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Betrag, Converter={x:Static local:IsNegativeConverter.Instance}}" Value="True">
                                                <Setter Property="Foreground" Value="#dc3545"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="200"/>
                            <DataGridTextColumn Header="IBAN" Binding="{Binding Konto}" Width="200"/>
                            <DataGridTextColumn Header="Verwendungszweck" Binding="{Binding Verwendungszweck}" Width="*"/>
                            <DataGridTextColumn Header="Rechnung" Binding="{Binding RechnungsNr}" Width="100"/>
                            <DataGridTextColumn Header="Kunde" Binding="{Binding KundenNr}" Width="80"/>
                            <DataGridTemplateColumn Header="Match" Width="60">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="3" Padding="4,2" HorizontalAlignment="Center">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#6c757d"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding MatchKonfidenz}" Value="100">
                                                            <Setter Property="Background" Value="#28a745"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding MatchKonfidenz}" Value="0">
                                                            <Setter Property="Background" Value="#dc3545"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding MatchKonfidenz, StringFormat={}{0}%}"
                                                       Foreground="White" FontSize="11"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Summenzeile -->
                    <Border Grid.Row="2" Background="#e8f4fc" BorderBrush="#0078D4" BorderThickness="0,1,0,0" Padding="10,8" Margin="0,5,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="txtSummeAnzahl" Text="0 Zahlungen" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <TextBlock Text="Summe:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <TextBlock x:Name="txtSummeBetrag" Text="0,00" FontWeight="Bold" Width="100" TextAlignment="Right" VerticalAlignment="Center"/>
                                <TextBlock Text="EUR" VerticalAlignment="Center" Margin="5,0,0,0"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Tab: SEPA Lastschriften -->
            <TabItem Header="SEPA Lastschriften" Padding="15,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- SEPA Header -->
                    <Border Background="#f8f8f8" Padding="10" Margin="0,0,0,10">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Faellige SEPA-Lastschriften" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <Button Content="Alle auswaehlen" Click="SepaAlleAuswaehlen_Click"
                                    Padding="10,4" Margin="20,0,0,0"/>
                            <Button Content="SEPA-XML exportieren" Click="SepaExport_Click"
                                    Background="#0078D4" Foreground="White" Padding="12,4" Margin="10,0,0,0" BorderThickness="0"/>
                        </StackPanel>
                    </Border>

                    <!-- SEPA DataGrid -->
                    <DataGrid x:Name="dgSepa" Grid.Row="1" AutoGenerateColumns="False" IsReadOnly="False"
                              SelectionMode="Extended" SelectionUnit="FullRow"
                              GridLinesVisibility="Horizontal" HeadersVisibility="Column"
                              RowBackground="White" AlternatingRowBackground="#fafafa">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="" Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Width="30"/>
                            <DataGridTextColumn Header="Rechnung" Binding="{Binding CRechnungsnummer}" Width="100" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Kunde" Binding="{Binding KundeName}" Width="200" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Betrag" Binding="{Binding Offen, StringFormat=N2}" Width="100" IsReadOnly="True">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTextColumn Header="Faelligkeit" Binding="{Binding Faelligkeit, StringFormat=dd.MM.yyyy}" Width="90" IsReadOnly="True"/>
                            <DataGridTextColumn Header="IBAN" Binding="{Binding CIBAN}" Width="200" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Mandatsreferenz" Binding="{Binding CMandatsreferenz}" Width="150" IsReadOnly="True"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- SEPA Summenzeile -->
                    <Border Grid.Row="2" Background="#e8f4fc" BorderBrush="#0078D4" BorderThickness="0,1,0,0" Padding="10,8" Margin="0,5,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="txtSepaAnzahl" Text="0 Lastschriften" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <TextBlock Text="Summe:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                                <TextBlock x:Name="txtSepaSumme" Text="0,00" FontWeight="Bold" Width="100" TextAlignment="Right" VerticalAlignment="Center"/>
                                <TextBlock Text="EUR" VerticalAlignment="Center" Margin="5,0,0,0"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>

            <!-- Tab: PayPal/Mollie Transaktionen -->
            <TabItem Header="Transaktionen (PayPal/Mollie)" Padding="15,5">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <!-- Provider Buttons -->
                    <Border Background="#f8f8f8" Padding="10" Margin="0,0,0,10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Orientation="Horizontal">
                                <Button x:Name="btnPayPalSync" Content="PayPal abrufen" Click="PayPalSync_Click"
                                        Background="#003087" Foreground="White" Padding="12,6" BorderThickness="0" Margin="0,0,10,0"/>
                                <Button x:Name="btnMollieSync" Content="Mollie abrufen" Click="MollieSync_Click"
                                        Background="#0a0a0a" Foreground="White" Padding="12,6" BorderThickness="0" Margin="0,0,10,0"/>
                                <TextBlock x:Name="txtProviderStatus" Text="" VerticalAlignment="Center" Foreground="#666" Margin="10,0,0,0"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <ComboBox x:Name="cmbProviderFilter" Width="100" SelectedIndex="0" SelectionChanged="ProviderFilter_Changed">
                                    <ComboBoxItem Content="Alle"/>
                                    <ComboBoxItem Content="PayPal"/>
                                    <ComboBoxItem Content="Mollie"/>
                                </ComboBox>
                            </StackPanel>
                        </Grid>
                    </Border>

                    <!-- Provider Transaktionen -->
                    <DataGrid x:Name="dgProvider" Grid.Row="1" AutoGenerateColumns="False" IsReadOnly="True"
                              SelectionMode="Single" SelectionUnit="FullRow"
                              GridLinesVisibility="Horizontal" HeadersVisibility="Column"
                              RowBackground="White" AlternatingRowBackground="#fafafa"
                              SelectionChanged="DgProvider_SelectionChanged">
                        <DataGrid.Columns>
                            <DataGridTemplateColumn Header="Anbieter" Width="80">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Padding="4,2" CornerRadius="3" HorizontalAlignment="Center">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#6c757d"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Provider}" Value="PayPal">
                                                            <Setter Property="Background" Value="#003087"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Provider}" Value="Mollie">
                                                            <Setter Property="Background" Value="#0a0a0a"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Provider}" Foreground="White" FontSize="11"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Datum" Binding="{Binding Datum, StringFormat=dd.MM.yyyy HH:mm}" Width="130"/>
                            <DataGridTextColumn Header="Betrag" Binding="{Binding Betrag, StringFormat=N2}" Width="100">
                                <DataGridTextColumn.ElementStyle>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="HorizontalAlignment" Value="Right"/>
                                        <Setter Property="FontWeight" Value="SemiBold"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IstRefund}" Value="True">
                                                <Setter Property="Foreground" Value="#dc3545"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGridTextColumn.ElementStyle>
                            </DataGridTextColumn>
                            <DataGridTemplateColumn Header="Status" Width="100">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border Padding="4,2" CornerRadius="3" HorizontalAlignment="Center">
                                            <Border.Style>
                                                <Style TargetType="Border">
                                                    <Setter Property="Background" Value="#ffc107"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding Status}" Value="paid">
                                                            <Setter Property="Background" Value="#28a745"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="S">
                                                            <Setter Property="Background" Value="#28a745"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="COMPLETED">
                                                            <Setter Property="Background" Value="#28a745"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="refunded">
                                                            <Setter Property="Background" Value="#6c757d"/>
                                                        </DataTrigger>
                                                        <DataTrigger Binding="{Binding Status}" Value="failed">
                                                            <Setter Property="Background" Value="#dc3545"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Border.Style>
                                            <TextBlock Text="{Binding Status}" Foreground="White" FontSize="11"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                            <DataGridTextColumn Header="Transaktion-ID" Binding="{Binding Id}" Width="180"/>
                            <DataGridTextColumn Header="Beschreibung" Binding="{Binding Beschreibung}" Width="200"/>
                            <DataGridTextColumn Header="Kunde" Binding="{Binding Kunde}" Width="150"/>
                            <DataGridTextColumn Header="Rechnung" Binding="{Binding RechnungNr}" Width="100"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <!-- Aktionen -->
                    <Border Grid.Row="2" Background="#e8f4fc" BorderBrush="#0078D4" BorderThickness="0,1,0,0" Padding="10,8" Margin="0,5,0,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock x:Name="txtProviderInfo" Text="0 Transaktionen" FontWeight="SemiBold" VerticalAlignment="Center"/>
                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button x:Name="btnRefund" Content="Rueckzahlung" Click="Refund_Click"
                                        Background="#dc3545" Foreground="White" Padding="15,6" BorderThickness="0" IsEnabled="False"/>
                                <Button x:Name="btnTxDetails" Content="Details" Click="TxDetails_Click"
                                        Padding="15,6" Margin="10,0,0,0" IsEnabled="False"/>
                            </StackPanel>
                        </Grid>
                    </Border>
                </Grid>
            </TabItem>
        </TabControl>

        <!-- Statusleiste -->
        <Border Grid.Row="2" Background="#f0f0f0" Padding="20,10" BorderBrush="#ddd" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock x:Name="txtStatus" Text="Bereit" Foreground="#666" VerticalAlignment="Center"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <Button x:Name="btnZuordnen" Content="Manuell zuordnen" Click="Zuordnen_Click"
                            Padding="12,5" IsEnabled="False"/>
                    <Button x:Name="btnDetails" Content="Details" Click="Details_Click"
                            Padding="12,5" Margin="10,0,0,0" IsEnabled="False"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
