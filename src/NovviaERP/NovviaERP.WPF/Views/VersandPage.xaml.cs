using System.Windows;using System.Windows.Controls;using NovviaERP.Core.Entities;using NovviaERP.Core.Services;
namespace NovviaERP.WPF.Views{public partial class VersandPage:Page{public VersandPage(){InitializeComponent();Loaded+=async(s,e)=>dgVersand.ItemsSource=await App.Db.GetBestellungenAsync(BestellStatus.Bezahlt);}
private async void Versenden_Click(object s,RoutedEventArgs e){var btn=(Button)s;var carrier=btn.Content.ToString()!;var id=(int)btn.Tag;var best=await App.Db.GetBestellungByIdAsync(id);if(best?.Lieferadresse==null)return;
var cfg=new ShippingConfig{AbsenderName="NOVVIA GmbH"};var svc=new ShippingService(cfg);var req=new ShipmentRequest{Referenz=best.BestellNr,EmpfaengerName=$"{best.Lieferadresse.Vorname} {best.Lieferadresse.Nachname}",EmpfaengerStrasse=best.Lieferadresse.Strasse??"",EmpfaengerPLZ=best.Lieferadresse.PLZ??"",EmpfaengerOrt=best.Lieferadresse.Ort??""};
var result=await svc.CreateShipmentAsync(req,carrier);if(result.Success){await App.Db.SetTrackingAsync(id,result.TrackingNumber,carrier);if(result.LabelPdf!=null)System.IO.File.WriteAllBytes($"Label_{best.BestellNr}.pdf",result.LabelPdf);MessageBox.Show($"Versandt! Tracking: {result.TrackingNumber}");}else MessageBox.Show($"Fehler: {result.Error}");}}}
